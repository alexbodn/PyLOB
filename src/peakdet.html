<!doctype html>
<html>
<body>
	<div>
		<canvas id="c1" height="320px"></canvas>
	</div>
	<script src="./peakdet.js"></script>
	<script src="./PyLOB/luxon/luxon.min.js"></script>
	<script src="./PyLOB/chart/chartjs/chart.umd.js"></script>
	<script src="./PyLOB/chart/chartjs-datalabels/chartjs-plugin-datalabels.min.js"></script>
	<script src="./PyLOB/chart/chartjs-luxon/chartjs-adapter-luxon.js"></script>
	<script>
	let input = [{
		"x": 1254233778000, "y": 51.778
	}, {
		"x": 1254233793000, "y": 51.76
	}, {
		"x": 1254233843000, "y": 51.74
	}, {
		"x": 1254233855000, "y": 51.72
	}, {
		"x": 1254233855005, "y": 51.71
	}, {
		"x": 1254233856000, "y": 51.7
	}, {
		"x": 1254233856003, "y": 51.71
	}, {
		"x": 1254233856004, "y": 51.72
	}, {
		"x": 1254233858000, "y": 51.71
	}, {
		"x": 1254233861000, "y": 51.72
	}, {
		"x": 1254233864000, "y": 51.71
	}, {
		"x": 1254233864009, "y": 51.7
	}, {
		"x": 1254233864010, "y": 51.69
	}, {
		"x": 1254233865000, "y": 51.68
	}, {
		"x": 1254233865007, "y": 51.69
	}, {
		"x": 1254233867000, "y": 51.68
	}, {
		"x": 1254233867003, "y": 51.69
	}, {
		"x": 1254233915000, "y": 51.7
	}, {
		"x": 1254233960000, "y": 51.68
	}, {
		"x": 1254234056000, "y": 51.665
	}, {
		"x": 1254234064000, "y": 51.68
	}, {
		"x": 1254234065000, "y": 51.7
	}, {
		"x": 1254234066000, "y": 51.68
	}, {
		"x": 1254234069000, "y": 51.69
	}, {
		"x": 1254234069009, "y": 51.68
	}, {
		"x": 1254234074000, "y": 51.67
	}, {
		"x": 1254234082000, "y": 51.65
	}, {
		"x": 1254234134000, "y": 51.64
	}, {
		"x": 1254234142000, "y": 51.66
	}, {
		"x": 1254234143000, "y": 51.67
	}, {
		"x": 1254234212000, "y": 51.69
	}, {
		"x": 1254234290000, "y": 51.642
	}, {
		"x": 1254234373000, "y": 51.67
	}, {
		"x": 1254234458000, "y": 51.69
	}, {
		"x": 1254234506000, "y": 51.68
	}, {
		"x": 1254234517002, "y": 51.678
	}, {
		"x": 1254234519000, "y": 51.67
	}, {
		"x": 1254234523000, "y": 51.661
	}, {
		"x": 1254234668000, "y": 51.72
	}, {
		"x": 1254234699000, "y": 51.69
	}, {
		"x": 1254234707000, "y": 51.6992
	}, {
		"x": 1254234774000, "y": 51.71
	}, {
		"x": 1254234774005, "y": 51.7054
	}, {
		"x": 1254234801000, "y": 51.671
	}, {
		"x": 1254234801005, "y": 51.6703
	}, {
		"x": 1254234801006, "y": 51.6701
	}, {
		"x": 1254234802000, "y": 51.6716
	}, {
		"x": 1254234822000, "y": 51.678
	}, {
		"x": 1254234868000, "y": 51.668
	}, {
		"x": 1254234869000, "y": 51.67
	}, {
		"x": 1254234873000, "y": 51.69
	}, {
		"x": 1254234891000, "y": 51.6708
	}, {
		"x": 1254234900000, "y": 51.7
	}, {
		"x": 1254234910000, "y": 51.71
	}, {
		"x": 1254234918000, "y": 51.69
	}, {
		"x": 1254234934000, "y": 51.66
	}, {
		"x": 1254234948000, "y": 51.67
	}, {
		"x": 1254234995000, "y": 51.69
	}, {
		"x": 1254234997004, "y": 51.7
	}, {
		"x": 1254234997007, "y": 51.71
	}, {
		"x": 1254235006000, "y": 51.7
	}, {
		"x": 1254235006001, "y": 51.69
	}, {
		"x": 1254235006008, "y": 51.7
	}, {
		"x": 1254235024000, "y": 51.71
	}, {
		"x": 1254235026000, "y": 51.72
	}, {
		"x": 1254235028006, "y": 51.73
	}, {
		"x": 1254235036000, "y": 51.75
	}, {
		"x": 1254235038000, "y": 51.73
	}, {
		"x": 1254235041000, "y": 51.74
	}, {
		"x": 1254235052000, "y": 51.75
	}, {
		"x": 1254235069000, "y": 51.72
	}, {
		"x": 1254235069005, "y": 51.71
	}, {
		"x": 1254235079000, "y": 51.75
	}, {
		"x": 1254235087000, "y": 51.7598
	}, {
		"x": 1254235088000, "y": 51.76
	}, {
		"x": 1254235098000, "y": 51.74
	}, {
		"x": 1254235189000, "y": 51.75
	}, {
		"x": 1254235203000, "y": 51.77
	}, {
		"x": 1254235218000, "y": 51.78
	}, {
		"x": 1254235229000, "y": 51.8075
	}, {
		"x": 1254235252000, "y": 51.77
	}, {
		"x": 1254235276000, "y": 51.78
	}, {
		"x": 1254235283000, "y": 51.77
	}, {
		"x": 1254235303000, "y": 51.76
	}, {
		"x": 1254235313000, "y": 51.74
	}, {
		"x": 1254235315000, "y": 51.73
	}, {
		"x": 1254235315005, "y": 51.72
	}, {
		"x": 1254235320000, "y": 51.712
	}, {
		"x": 1254235323000, "y": 51.72
	}, {
		"x": 1254235324000, "y": 51.721
	}, {
		"x": 1254235328000, "y": 51.702
	}, {
		"x": 1254235343000, "y": 51.71
	}, {
		"x": 1254235371000, "y": 51.69
	}, {
		"x": 1254235373000, "y": 51.68
	}, {
		"x": 1254235383000, "y": 51.69
	}, {
		"x": 1254235384000, "y": 51.6856
	}, {
		"x": 1254235403000, "y": 51.69
	}, {
		"x": 1254235413000, "y": 51.68
	}, {
		"x": 1254235427000, "y": 51.6846
	}, {
		"x": 1254235433000, "y": 51.69
	}, {
		"x": 1254235439000, "y": 51.71
	}, {
		"x": 1254235443000, "y": 51.69
	}, {
		"x": 1254235444000, "y": 51.7
	}, {
		"x": 1254235445000, "y": 51.7082
	}, {
		"x": 1254235446000, "y": 51.69
	}, {
		"x": 1254235463000, "y": 51.65
	}, {
		"x": 1254235473000, "y": 51.67
	}, {
		"x": 1254235473005, "y": 51.66
	}, {
		"x": 1254235503000, "y": 51.64
	}, {
		"x": 1254235520000, "y": 51.65
	}];
	</script>
	<script>
		var config = {
			type: 'line',
		plugins: [ChartDataLabels],
		options: {
			animation: false,
			normalized: true,
		    plugins: {
		      datalabels: {
		        backgroundColor: function(context) {
		          return context.dataset.backgroundColor;
		        },
		        borderRadius: 4,
		        color: function(context) {
		        	return labelattr(context, 'color');
		        },
		        //color: 'white',
		        font: {
		          weight: 'bold'
		        },
		        formatter: function(value, context) {
		        	return labelattr(context, 'text');
		        },
		        padding: 1
		      }
		    },
		/**/scales: {
      	x: {
            type: 'time',
					time: {
						unit: "minute",
						tooltipFormat: "HH:mm:ss.SSS",
						tooltipFormat0: "x",
						displayFormats: {
							millisecond: 'HH:mm:ss.SSS',
							second: 'HH:mm:ss',
							minute: 'HH:mm:ss',
							millisecond0: 'x',
							second0: 'x',
							minute0: 'x',
							/*'hour': 'HH:mm:ss',
							'day': 'HH:mm:ss',
							'week': 'HH:mm:ss',
							'month': 'HH:mm:ss',
							'quarter': 'HH:mm:ss',
							'year': 'HH:mm:ss',*/
						},
					},
					adapters: {
						date: {
							zone: 'America/New_York',
						},
					},
					ticks: {
						source: 'data'
					}
      	},
        },/**/
		},
		data: {
			datasets: []
		},
	};
	</script>

	<script>
	function labelattr(context, attr)
	{
		var label = context.chart.data.datasets[context.datasetIndex].data[context.dataIndex].label;
		if (label) {
			return label[attr];
		}
		return null;
	}

	function chartfill(chart, prices, minprofit, capital, hidden)
	{
	let allev2 = [];
	let delta = 0.1343396226;
	let [maxtab, mintab] = peakdet2(
		input, delta, {getv: v => v.y, allev: allev2});
	console.log(delta, allev2, maxtab, mintab)

		//console.log(JSON.stringify(maxtab)),
		chart.data.datasets[0] = {label: 'price', data: input, hidden: hidden};
		chart.data.datasets[1] = {label: 'ev', data: allev2};
		chart.data.datasets[2] = {label: 'peaks', data: maxtab};
		chart.data.datasets[3] = {label: 'valeys', data: mintab};
	}
	function inputNumber(id)
	{
		var elem = document.getElementById(id);
		if (elem) {
			var value = elem.value;
			if (value) {
				return parseFloat(value.replace(',', ''));
			}
		}
		return null;
	}
		
	var chart = new Chart(
		document.getElementById('c1'),
		config,
	);
	function chartupdate()
	{
		chartfill(
			chart, 
			prices=input, 
			minprofit=inputNumber('minprofit'), 
			capital=inputNumber('capital'),
			show=true,
		);
		chart.update();
	}
	chartupdate();
	</script>
</body>
</html>