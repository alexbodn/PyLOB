<!DOCTYPE html>
<html lang="en-us">
<head>
	<script>
		let dates = [
			'2009-09-28',
			'2009-09-29',
			'2009-09-30',
			/*
			'2009-10-01',
			'2009-10-02',
			'2009-10-05',
			'2009-10-06',
			*/
		];
	</script>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon" />
	<title>simulob</title>
	<style>
		.warning, .error {color: red}
		.error {background-color: yellow}
		div#log {
			display: flex;
			flex-direction: column;
			font-family: monospace;
			white-space: break-spaces;
		}
		.lob-header * {
			float: left;
		}
	</style>
	<!--link rel="stylesheet" href="./flex.css" /-->
	<link rel="stylesheet" href="./tabs.css" />
	<!--style>
	</style-->
	<script src="./PyLOB/sqlquery.js"></script>
</head>
<body>
	<div>
		<h1>simulob</h1>
		<h3 class="lob-header">
			<img id="loading" src="./loading.png" style="display: none; height: 20px;" />
			<img id="paused" src="./paused.png" style="display: none; height: 20px;" />
			<span>NLV</span>
			<span id="nlv"></span>
		</h3>
		<table>
			<tbody id="balance"></tbody>
		</table>
	</div>
	<table id="buttons" style="display: none">
		<tbody>
		<tr>
			<td><input value="ðŸ‘¾" title="debug" id="debug" type="button" onclick="sob.setDebug();" /></td>
			<td><button title="stop debug" id="stop-debug" onclick="sob.setDebug(false);"><strike>ðŸ‘¾</strike></button></td>
			<td><input value="â¸ï¸" title="pause" id="pause" type="button" onclick="sob.pause();" /></td>
			<td><input value="â¹ï¸" title="stop" id="stop" type="button" onclick="simuStop();" /></td>
			<td><input value="â–¶ï¸" title="run" id="run" type="button" onclick="simuPlay();" /></td>
		</tr>
		<!--tr>
			<td colspan="7">
				<div style="width: 100%">
					<label for="configFile" class="btn">Select config</label>
					<input id="configFile" style="visibility:hidden;" type="file" accept=".json" />
				</div>
			</td>
		</tr-->
		<!--tr>
			<td colspan="4">
				<select id="charts"></select>
			</td>
			<td colspan="3">
				<button onclick="saveChart()">save chart</button>
			</td>
		</tr-->
		</tbody>
	</table>
	<div id="charts" class="flex-container container">
		<div class="tabs"></div>
		<div class="tab-content"></div>
	</div>
	<table>
		<tbody id="status"></tbody>
	</table>
	<div id="sqlQuery"></div>
	<table>
		<tbody id="config"></tbody>
	</table>
	<div style="overflow: scroll; height: 320px; border-style: ridge;">
		<div id="log"></div>
	</div>


<!-- The `multiple` attribute lets users select multiple files. -->
	<!--script>
		const cfgSelector = document.querySelector('#configFile');
		cfgSelector.addEventListener('change', (event) => {
			const file = event.target.files[0];
			let reader = new FileReader();
			reader.readAsText(file);
			reader.onload = function(event) {
				var cfgData = event.target.result;
				simuDefaults = JSON.parse(cfgData);
				console.log(simuDefaults);
			};
			reader.onerror = function() {
				alert('Unable to read ' + file.fileName);
			};
		});
	</script-->
	<script src="./PyLOB/sqlitejs/sqlite3.js"></script>
	<script src="./PyLOB/orderbook.js"></script>
	<!--script src="./example.js"></script-->
	<script src="./simuhooks.js"></script>
	<script src="./commission.js"></script>
	<script src="./peakdet.js"></script>
	<script src="./PyLOB/simulob.js"></script>
	
	<script src="./PyLOB/chart/chartjs-4.4.0/chart.umd.min.js"></script>
	<!--script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script-->
	<script src="./PyLOB/chart/chartjs-datalabels/chartjs-plugin-datalabels.min.js"></script>

	<script src="./PyLOB/hammerjs/hammer.min.js"></script>
	<script src="./PyLOB/chart/chartjs-zoom/chartjs-plugin-zoom.min.js"></script>
	<!--script src="./PyLOB/chart/chartjs-streaming/chartjs-plugin-streaming.min.js"></script-->
	<script src="./PyLOB/luxon/luxon.min.js"></script>
	<script src="./PyLOB/chart/chartjs-luxon/chartjs-adapter-luxon.js"></script>
	
	<script src="./PyLOB/jszip/jszip.min.js"></script>
	<!--script src="./PyLOB/eruda/eruda.js"></script-->
	<script src="./PyLOB/file-saver/FileSaver.js"></script>
	<script src="./PyLOB/csv/papaparse.min.js"></script>
	<script src="./loaddata.js"></script>
	<!--script>
		//var FileSaver = require('file-saver');
		var file = new File(["Hello, world!"], "hello world.txt", {type: "text/plain;charset=utf-8"});
		saveAs(file);
	</script-->
	<script>
	/**
	Set up our output channel differently depending
	on whether we are running in a worker thread or
	the main (UI) thread.
	*/
	let logHtml;
	if(self.window === self /* UI thread */){
		console.log("Running demo from main UI thread.");
		logHtml = function(cssClass,...args){
			//const ln = document.createElement('div');
			//if(cssClass) ln.classList.add(cssClass);
			//ln.append(document.createTextNode(args.join(' ')));
			let logDiv = document.querySelector("div#log");
			logDiv.insertAdjacentHTML(
				'beforeend', `<div class="${cssClass}">${args.join(' ')}</div>`
			);
		};
	}
	else{ /* Worker thread */
		console.log("Running demo from Worker thread.");
		logHtml = function(cssClass,...args){
			postMessage({
				type:'log',
				payload:{cssClass, args}
			});
		};
	}
	const log = (...args)=>logHtml('',...args);
	const warn = (...args)=>logHtml('warning',...args);
	const error = (...args)=>logHtml('error',...args);
	</script>
	<script>
	if(self.window!==self) /*worker thread*/{
		/*
		If sqlite3.js is in a directory other than this script, in order
		to get sqlite3.js to resolve sqlite3.wasm properly, we have to
		explicitly tell it where sqlite3.js is being loaded from. We do
		that by passing the `sqlite3.dir=theDirName` URL argument to
		_this_ script. That URL argument will be seen by the JS/WASM
		loader and it will adjust the sqlite3.wasm path accordingly. If
		sqlite3.js/.wasm are in the same directory as this script then
		that's not needed.

		URL arguments passed as part of the filename via importScripts()
		are simply lost, and such scripts see the self.location of
		_this_ script.
		*/
		let sqlite3Js = 'sqlite3.js';
		const urlParams = new URL(self.location.href).searchParams;
		if(urlParams.has('sqlite3.dir')){
			sqlite3Js = urlParams.get('sqlite3.dir') + '/' + sqlite3Js;
		}
		importScripts(sqlite3Js);
	}
	self.sqlite3InitModule({
		// We can redirect any stdout/stderr from the module
		// like so...
		print: log,
		printErr: console.error
	}).then(function(sqlite3){
		//log("Done initializing. Running demo...");
		try {
			//const
			oo = sqlite3.oo1/*high-level OO API*/;
			let buttons = document.querySelector("#buttons");
			buttons.style.display = 'block';
			showConfig();
		}
		catch(e){
			oo = null;
			warn("Exception:",e.message);
		}
	});
	</script>
	<script>
	function saveChart() {
		let label = document.querySelector('select#charts').value;
console.log(label);
		let data = window.sob.chartData(label);
console.log(data.length);
		let json = JSON.stringify(data, null, 2);
		let fileName = `${label}-data.json`;
console.log(json.length);
		let file = new File([json], fileName, {type: "text/plain;charset=utf-8"});
console.log(file);
var blob = new Blob([json], {type: "text/plain;charset=utf-8"});
		//saveAs(file);
		saveAs(blob, fileName);
console.log('label done?');
	}
	function datasetIndex(chart, label) {
		return chart.legend.legendItems.findIndex(item => item.text == label);
	}
	function chartupdate()
	{
		let index = datasetIndex(sob.chart, 'ask');
		if (index >= 0) {
			sob.chart.setDatasetVisibility(index, !sob.chart.isDatasetVisible(index));
			sob.chart.update();
		}
	}
	function simuStop() {
		let logDiv = document.querySelector("div#log");
		logDiv.textContent = '';
		if (window.sob) {
			sob.close();
			window.sob = undefined;
		}
	}
	function simuPlay() {
		if (window.sob && sob.dopause) {
			sob.pause(false);
		}
		else {
			simuStop();
			runsob(oo);
		}
	}
	function studyBid(chartLabel) {
		sob.studySide('bid', chartLabel);
	}
	function studyAsk(chartLabel) {
		sob.studySide('ask', chartLabel);
	}
	function runsob(oo) {
		let dbname = "/mydb.sqlite3";
		dbname = ':memory:';
		const db = new oo.DB(dbname,'c');
		// isolation_level: null
		let myurl = window.location.href;
		let mydir = myurl.slice(0, myurl.lastIndexOf('/'));
		fetchText('create_db', mydir + '/create_lob.sql')
		.then(function(sql) {
			//sql[1] = sql[1].replaceAll('begin transaction;', '').replaceAll('commit;');
			//try
			db.exec({
				sql: sql[1],
			});
			//finally
			window.sob = new SimuLOB(
				mydir + '/PyLOB', fetchText, db,
				undefined, undefined, 'div#charts', 'c1');
			window.sob.init().then(
				obj => {
					//log(obj);
					/*let chartSelect = document.querySelector('select#charts');
					chartSelect.textContent = '';
					for (let dataset of window.sob.chartDatasets()) {
						let row =
							`<option value="${dataset}">
								${dataset}
							</option>`;
						chartSelect.insertAdjacentHTML('beforeend', row);
					}*/
//todo build dataset select list
					window.sqlConsole = new SQLQuery('div#sqlQuery', db, 'sqlConsole');
					
					window.sob.run(dates);
				}
			);
		});
	}
	</script>
	<script>
		function tabClick(tab, chartContainer) {
			chartContainer = document.querySelector(chartContainer);
			const tabLabels = chartContainer.querySelectorAll('[data-tab-value]');
			tabLabels.forEach(tabLabel => {
				tabLabel.classList.remove('active');
			});
			tab.classList.add('active');
			const tabInfos = chartContainer.querySelectorAll('[data-tab-info]');
			tabInfos.forEach(tabInfo => {
				tabInfo.classList.remove('active');
			});
			const target = document.querySelector(tab.dataset.tabValue);
			target.classList.add('active');
		}
	</script>
	<script>window.eruda && (eruda._isInit || eruda.init());</script>
</body>
</html>
