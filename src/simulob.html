<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon" />
	<title>simulob</title>
	<style>
		.warning, .error {color: red}
		.error {background-color: yellow}
		body {
			display: flex;
			flex-direction: column;
			font-family: monospace;
			white-space: break-spaces;
		}
	</style>
</head>
<body>
	<h1>simulob</h1>

	<div>
		<div>
			<div style="display: flex;">
				<span>
					capital
				</span>
				<div>
					<input id="capital" value="22,000" type="text" />
				</div>
			</div>
			<div style="display: flex;">
				<span>
					minimum profit
				</span>
				<div>
					<input id="minprofit" value="10" type="text" />
				</div>
			</div>
			<div style="display: flex;">
				<input value="chart update" id="update" type="button" onclick="chartupdate()" />
				<input value="study bid" id="study-bid" type="button" onclick="studyBid()" />
				<input value="study ask" id="study-ask" type="button" onclick="studyAsk()" />				</div>
			</div>
		</div>
		<div>
			<canvas id="c1" height="320px"></canvas>
			<img id="loading" src="./ezgif.com-gif-maker.gif" />
		</div>
	</div>
	<script src="./PyLOB/sqlitejs/sqlite3.js"></script>
	<script src="./PyLOB/orderbook.js"></script>
	<!--script src="./example.js"></script-->
	<script src="./simuhooks.js"></script>
	<script src="./PyLOB/simulob.js"></script>
	<script src="./PyLOB/chart/luxon/luxon.min.js"></script>
	<script src="./PyLOB/chart/chartjs/chart.umd.js"></script>
	<script src="./PyLOB/chart/chartjs-datalabels/chartjs-plugin-datalabels.min.js"></script>
	<!--script src="./PyLOB/chart/chartjs-streaming/chartjs-plugin-streaming.min.js"></script-->
	<script src="./PyLOB/chart/luxon/chartjs-adapter-luxon.js"></script>
	<script src="./PyLOB/chart/data.js"></script>
	<script src="./PyLOB/chart/commission.js"></script>
	<script src="./PyLOB/chart/peakdet.js"></script>
	<script src="./data.js"></script>
	<script>
	/**
	Set up our output channel differently depending
	on whether we are running in a worker thread or
	the main (UI) thread.
	*/
	let logHtml;
	if(self.window === self /* UI thread */){
		console.log("Running demo from main UI thread.");
		logHtml = function(cssClass,...args){
			const ln = document.createElement('div');
			if(cssClass) ln.classList.add(cssClass);
			//ln.append(document.createTextNode(args.join(' ')));
			///ln.append(createHTMLNode(args.join(' ')));
			///document.body.append(ln);
			///const element = document.querySelector('body');
			document.body.insertAdjacentHTML(
				'beforeend', args.join(' ')
			);
		};
	}
	else{ /* Worker thread */
		console.log("Running demo from Worker thread.");
		logHtml = function(cssClass,...args){
			postMessage({
				type:'log',
				payload:{cssClass, args}
			});
		};
	}
	const log = (...args)=>logHtml('',...args);
	const warn = (...args)=>logHtml('warning',...args);
	const error = (...args)=>logHtml('error',...args);
	</script>
	<script>
	if(self.window!==self) /*worker thread*/{
		/*
		If sqlite3.js is in a directory other than this script, in order
		to get sqlite3.js to resolve sqlite3.wasm properly, we have to
		explicitly tell it where sqlite3.js is being loaded from. We do
		that by passing the `sqlite3.dir=theDirName` URL argument to
		_this_ script. That URL argument will be seen by the JS/WASM
		loader and it will adjust the sqlite3.wasm path accordingly. If
		sqlite3.js/.wasm are in the same directory as this script then
		that's not needed.

		URL arguments passed as part of the filename via importScripts()
		are simply lost, and such scripts see the self.location of
		_this_ script.
		*/
		let sqlite3Js = 'sqlite3.js';
		const urlParams = new URL(self.location.href).searchParams;
		if(urlParams.has('sqlite3.dir')){
			sqlite3Js = urlParams.get('sqlite3.dir') + '/' + sqlite3Js;
		}
		importScripts(sqlite3Js);
	}
	self.sqlite3InitModule({
		// We can redirect any stdout/stderr from the module
		// like so...
		print: log,
		printErr: console.error
	}).then(function(sqlite3){
		//log("Done initializing. Running demo...");
		try {
			let myurl = window.location.href;
			let mydir = myurl.slice(0, myurl.lastIndexOf('/'));
			const oo = sqlite3.oo1/*high-level OO API*/;
			const db = new oo.DB("/mydb.sqlite3",'c');
			// isolation_level: null
			fetchText('create_db', mydir + '/create_lob.sql')
			.then(function(sql) {
				//sql[1] = sql[1].replaceAll('begin transaction;', '').replaceAll('commit;');
				//try
				db.exec({
					sql: sql[1],
				});
				//finally
				sob = new SimuLOB(
						mydir + '/PyLOB', fetchText, db, 
						undefined, undefined, 'c1');
				sob.init().then(
					obj => {
						//log(obj);
						sob.run(data);
					}
				); 
			});
		}
		catch(e){
			warn("Exception:",e.message);
		}
	});
	</script>
	<script>
	function datasetIndex(chart, label) {
		return chart.legend.legendItems.findIndex(item => item.text == label);
	}
	function chartupdate()
	{
		let index = datasetIndex(sob.chart, 'ask');
		if (index >= 0) {
			sob.chart.setDatasetVisibility(index, !sob.chart.isDatasetVisible(index));
			sob.chart.update();
		}
	}
	function studyBid() {
		sob.studySide('bid');
	}
	function studyAsk() {
		sob.studySide('ask');
	}

	</script>
</body>
</html>
